### PROJECT TREE (cortes + shifts domain) ###
app/(dashboard)/cortes
├── _components
│   ├── abrir-corte-modal.tsx
│   ├── cerrar-corte-modal.tsx
│   ├── cortes-filtros.tsx
│   ├── cortes-lista.tsx
│   ├── cortes-manager.tsx
│   ├── cortes-skeleton.tsx
│   └── detalle-corte-modal.tsx
├── loading.tsx
├── page.tsx
└── README.md
lib/api/shifts.client.ts  [error opening dir]
lib/domain/shifts
├── index.ts
├── shift-calculations.ts
├── shift-formatters.ts
└── shift-operations.ts
types/api/shifts.ts  [error opening dir]

3 directories, 16 files


### FILE CONTENTS ###

import { requireAuth } from "@/lib/require-role";
import { prisma } from "@/lib/db";
import CortesManager from "./_components/cortes-manager";

async function getCajeros() {
  const users = await prisma.user.findMany({
    where: { isActive: true },
    select: { id: true, name: true },
    orderBy: { name: "asc" },
  });
  return users;
}

export default async function CortesPage() {
  const session = await requireAuth();
  const cajeros = await getCajeros();

  return <CortesManager cajeros={cajeros} currentUserId={session.user.id} />;
}
import CortesSkeleton from "./_components/cortes-skeleton";

export default function Loading() {
  return <CortesSkeleton />;
}


### FILE: app/(dashboard)/cortes/_components/abrir-corte-modal.tsx ###

"use client";

import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from "@/components/ui/dialog";
import { DollarSign, Loader2 } from "lucide-react";
import { OpenShiftSchema, type OpenShiftInput } from "@/types/api/shifts";

interface AbrirCorteModalProps {
  open: boolean;
  onClose: () => void;
  onSubmit: (data: OpenShiftInput) => Promise<void>;
  error?: string;
}

export default function AbrirCorteModal({
  open,
  onClose,
  onSubmit,
  error,
}: AbrirCorteModalProps) {
  const {
    register,
    handleSubmit,
    formState: { errors, isSubmitting },
    reset,
  } = useForm<OpenShiftInput>({
    resolver: zodResolver(OpenShiftSchema),
  });

  const handleClose = () => {
    reset();
    onClose();
  };

  const handleFormSubmit = async (data: OpenShiftInput) => {
    await onSubmit(data);
  };

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="sm:max-w-md">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <DollarSign className="h-5 w-5" />
            Abrir Corte de Caja
          </DialogTitle>
          <DialogDescription>
            Ingresa el fondo inicial en efectivo para comenzar el turno
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit(handleFormSubmit)} className="space-y-4">
          {error && (
            <div className="rounded-lg bg-destructive/10 p-3 text-sm text-destructive">
              {error}
            </div>
          )}

          <div className="space-y-2">
            <Label htmlFor="fondoInicial">Fondo Inicial *</Label>
            <div className="relative">
              <span className="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">
                $
              </span>
              <Input
                id="fondoInicial"
                type="number"
                step="0.01"
                min="0"
                placeholder="0.00"
                {...register("initialCash", { valueAsNumber: true })}
                className="pl-7"
                autoFocus
              />
            </div>
            {errors.initialCash && (
              <p className="text-sm text-destructive">
                {errors.initialCash.message}
              </p>
            )}
            <p className="text-xs text-muted-foreground">
              Monto en efectivo con el que inicias el turno
            </p>
          </div>

          <div className="flex gap-2 pt-4">
            <Button
              type="button"
              variant="outline"
              onClick={handleClose}
              disabled={isSubmitting}
              className="flex-1"
            >
              Cancelar
            </Button>
            <Button
              type="submit"
              disabled={isSubmitting}
              className="flex-1 gap-2"
            >
              {isSubmitting && <Loader2 className="h-4 w-4 animate-spin" />}
              Abrir Corte
            </Button>
          </div>
        </form>
      </DialogContent>
    </Dialog>
  );
}


### FILE: app/(dashboard)/cortes/_components/cerrar-corte-modal.tsx ###

"use client";

import { useState, useEffect, useCallback } from "react";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Textarea } from "@/components/ui/textarea";
import {
  Dialog,
  DialogContent,
  DialogHeader,
  DialogTitle,
  DialogDescription,
} from "@/components/ui/dialog";
import { CheckCircle, Loader2, AlertCircle } from "lucide-react";
import { CloseShiftSchema, type CloseShiftInput } from "@/types/api/shifts";
import type { ResumenCorteResponse, CorteResponse } from "@/types/api/shifts";
import {
  calcularDiferencia,
  calcularEfectivoEsperado,
  tieneDiferenciaSignificativa,
  tipoDiferencia,
} from "@/lib/domain/shifts";

interface CerrarCorteModalProps {
  open: boolean;
  corte: CorteResponse;
  onClose: () => void;
  onLoadResumen: (corteId: number) => Promise<ResumenCorteResponse>;
  onSubmit: (data: CloseShiftInput) => Promise<void>;
  error?: string;
}

export default function CerrarCorteModal({
  open,
  corte,
  onClose,
  onLoadResumen,
  onSubmit,
  error,
}: CerrarCorteModalProps) {
  const [resumen, setResumen] = useState<ResumenCorteResponse | null>(null);
  const [loading, setLoading] = useState(true);
  const [loadError, setLoadError] = useState("");

  const {
    register,
    handleSubmit,
    watch,
    setValue,
    formState: { isSubmitting },
    reset,
  } = useForm<CloseShiftInput>({
    resolver: zodResolver(CloseShiftSchema),
    defaultValues: {
      shiftId: corte.id,
      cashAmount: 0,
      debitCardAmount: 0,
      creditCardAmount: 0,
      totalWithdrawals: 0,
      withdrawalsConcept: "",
      notes: "",
      difference: 0,
    },
  });

  const watchedValues = watch();

  const diferencia = resumen
    ? calcularDiferencia(resumen, {
        cashAmount: Number(watchedValues.cashAmount) || 0,
        debitCardAmount: Number(watchedValues.debitCardAmount) || 0,
        creditCardAmount: Number(watchedValues.creditCardAmount) || 0,
        totalWithdrawals: Number(watchedValues.totalWithdrawals) || 0,
      })
    : 0;

  const cargarResumen = useCallback(async () => {
    try {
      setLoading(true);
      const data = await onLoadResumen(corte.id);
      setResumen(data);

      setValue("debitCardAmount", Number(data.debitCardAmount) || 0);
      setValue("creditCardAmount", Number(data.creditCardAmount) || 0);
      setValue("totalWithdrawals", Number(data.totalWithdrawals) || 0);

      const efectivoEsperado = calcularEfectivoEsperado(data);
      setValue("cashAmount", efectivoEsperado);
    } catch (err) {
      setLoadError(err instanceof Error ? err.message : "Error desconocido");
    } finally {
      setLoading(false);
    }
  }, [corte.id, onLoadResumen, setValue]);

  useEffect(() => {
    if (open) {
      cargarResumen();
    }
  }, [open, cargarResumen]);

  useEffect(() => {
    if (resumen) {
      setValue("difference", diferencia);
    }
  }, [resumen, diferencia, setValue]);

  const handleClose = () => {
    reset();
    setResumen(null);
    setLoadError("");
    onClose();
  };

  const handleFormSubmit = async (data: CloseShiftInput) => {
    await onSubmit(data);
  };

  if (loading) {
    return (
      <Dialog open={open} onOpenChange={handleClose}>
        <DialogContent className="sm:max-w-2xl">
          <DialogTitle className="sr-only">Cargando...</DialogTitle>
          <div className="flex items-center justify-center py-8">
            <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
          </div>
        </DialogContent>
      </Dialog>
    );
  }

  const tieneDiferencia = tieneDiferenciaSignificativa(diferencia);
  const tipo = tipoDiferencia(diferencia);

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent className="sm:max-w-2xl max-h-[90vh] overflow-y-auto">
        <DialogHeader>
          <DialogTitle className="flex items-center gap-2">
            <CheckCircle className="h-5 w-5" />
            Cerrar Corte de Caja
          </DialogTitle>
          <DialogDescription>
            Folio: {corte.folio} - Realiza el arqueo de caja
          </DialogDescription>
        </DialogHeader>

        <form onSubmit={handleSubmit(handleFormSubmit)} className="space-y-4">
          {(error || loadError) && (
            <div className="rounded-lg bg-destructive/10 p-3 text-sm text-destructive">
              {error || loadError}
            </div>
          )}

          {resumen && (
            <div className="bg-muted/50 rounded-lg p-4 space-y-2 border">
              <h3 className="font-semibold text-sm">Resumen del Turno</h3>
              <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 text-sm">
                <div>
                  <p className="text-muted-foreground">Fondo Inicial</p>
                  <p className="font-medium">
                    ${Number(resumen.initialCash).toFixed(2)}
                  </p>
                </div>
                <div>
                  <p className="text-muted-foreground">Tickets</p>
                  <p className="font-medium">{resumen.ticketCount}</p>
                </div>
                <div>
                  <p className="text-muted-foreground">Ventas Totales</p>
                  <p className="font-medium">
                    ${Number(resumen.totalSales).toFixed(2)}
                  </p>
                </div>
                <div>
                  <p className="text-muted-foreground">Efectivo Esperado</p>
                  <p className="font-medium">
                    $
                    {(
                      Number(resumen.initialCash) + Number(resumen.cashAmount)
                    ).toFixed(2)}
                  </p>
                </div>
              </div>
            </div>
          )}

          <div className="space-y-3">
            <h3 className="font-semibold text-sm">Arqueo de Caja</h3>

            <div className="grid grid-cols-1 sm:grid-cols-2 gap-3">
              <div className="space-y-2">
                <Label htmlFor="cashAmount">Efectivo en Caja *</Label>
                <div className="relative">
                  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">
                    $
                  </span>
                  <Input
                    id="cashAmount"
                    type="number"
                    step="0.01"
                    min="0"
                    {...register("cashAmount", { valueAsNumber: true })}
                    className="pl-7"
                  />
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="debitCardAmount">Tarjeta Débito</Label>
                <div className="relative">
                  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">
                    $
                  </span>
                  <Input
                    id="debitCardAmount"
                    type="number"
                    step="0.01"
                    min="0"
                    {...register("debitCardAmount", { valueAsNumber: true })}
                    className="pl-7"
                  />
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="creditCardAmount">Tarjeta Crédito</Label>
                <div className="relative">
                  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">
                    $
                  </span>
                  <Input
                    id="creditCardAmount"
                    type="number"
                    step="0.01"
                    min="0"
                    {...register("creditCardAmount", { valueAsNumber: true })}
                    className="pl-7"
                  />
                </div>
              </div>

              <div className="space-y-2">
                <Label htmlFor="totalWithdrawals">Retiros</Label>
                <div className="relative">
                  <span className="absolute left-3 top-1/2 -translate-y-1/2 text-muted-foreground">
                    $
                  </span>
                  <Input
                    id="totalWithdrawals"
                    type="number"
                    step="0.01"
                    min="0"
                    {...register("totalWithdrawals", { valueAsNumber: true })}
                    className="pl-7"
                  />
                </div>
              </div>
            </div>

            {Number(watchedValues.totalWithdrawals) > 0 && (
              <div className="space-y-2">
                <Label htmlFor="withdrawalsConcept">Concepto de Retiros</Label>
                <Input
                  id="withdrawalsConcept"
                  placeholder="Ej: Pago de proveedores, gastos varios..."
                  {...register("withdrawalsConcept")}
                />
              </div>
            )}

            <div className="space-y-2">
              <Label htmlFor="notes">Notas (Opcional)</Label>
              <Textarea
                id="notes"
                placeholder="Observaciones del cierre..."
                {...register("notes")}
                rows={2}
              />
            </div>
          </div>

          {tieneDiferencia && (
            <div
              className={`rounded-lg p-4 border ${
                tipo === "sobrante"
                  ? "bg-green-50 dark:bg-green-950/20 border-green-200 dark:border-green-900"
                  : "bg-red-50 dark:bg-red-950/20 border-red-200 dark:border-red-900"
              }`}
            >
              <div className="flex items-center gap-2">
                <AlertCircle
                  className={`h-5 w-5 ${
                    tipo === "sobrante"
                      ? "text-green-600 dark:text-green-500"
                      : "text-red-600 dark:text-red-500"
                  }`}
                />
                <div>
                  <p className="font-medium">
                    {tipo === "sobrante" ? "Sobrante" : "Faltante"}: $
                    {Math.abs(diferencia).toFixed(2)}
                  </p>
                  <p className="text-sm text-muted-foreground">
                    {tipo === "sobrante"
                      ? "Hay más dinero del esperado"
                      : "Falta dinero en el arqueo"}
                  </p>
                </div>
              </div>
            </div>
          )}

          <div className="flex gap-2 pt-4 border-t">
            <Button
              type="button"
              variant="outline"
              onClick={handleClose}
              disabled={isSubmitting}
              className="flex-1"
            >
              Cancelar
            </Button>
            <Button
              type="submit"
              disabled={isSubmitting}
              className="flex-1 gap-2"
              variant={tieneDiferencia ? "destructive" : "default"}
            >
              {isSubmitting && <Loader2 className="h-4 w-4 animate-spin" />}
              {tieneDiferencia ? "Cerrar con Diferencia" : "Cerrar Corte"}
            </Button>
          </div>
        </form>
      </DialogContent>
    </Dialog>
  );
}


### FILE: app/(dashboard)/cortes/_components/cortes-filtros.tsx ###

"use client";

import { useState } from "react";
import { Card, CardContent } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { Search, X, Filter, Calendar } from "lucide-react";

export interface FiltrosCorte {
  busqueda: string;
  fechaInicio: string;
  fechaFin: string;
  cajero: string;
  estado: "todos" | "abiertos" | "cerrados";
  ordenarPor: "fecha_desc" | "fecha_asc" | "folio_desc" | "folio_asc";
}

interface Cajero {
  id: string;
  name: string;
}

interface CortesFiltrosProps {
  filtros: FiltrosCorte;
  onFiltrosChange: (filtros: FiltrosCorte) => void;
  onAplicarFiltros: () => void;
  cajeros: Cajero[];
  loading: boolean;
}

export default function CortesFiltros({
  filtros,
  onFiltrosChange,
  onAplicarFiltros,
  cajeros,
  loading,
}: CortesFiltrosProps) {
  const [mostrarFiltros, setMostrarFiltros] = useState(false);

  const handleChange = (key: keyof FiltrosCorte, value: string) => {
    onFiltrosChange({ ...filtros, [key]: value });
  };

  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === "Enter") {
      onAplicarFiltros();
    }
  };

  const limpiarFiltros = () => {
    const filtrosLimpios: FiltrosCorte = {
      busqueda: "",
      fechaInicio: "",
      fechaFin: "",
      cajero: "todos",
      estado: "todos",
      ordenarPor: "fecha_desc",
    };
    onFiltrosChange(filtrosLimpios);
  };

  const establecerRangoFecha = (tipo: "hoy" | "semana" | "mes") => {
    const hoy = new Date();
    const fin = hoy.toISOString().split("T")[0];
    let inicio = "";

    switch (tipo) {
      case "hoy":
        inicio = fin;
        break;
      case "semana":
        const semanaAtras = new Date(hoy);
        semanaAtras.setDate(semanaAtras.getDate() - 7);
        inicio = semanaAtras.toISOString().split("T")[0];
        break;
      case "mes":
        const mesAtras = new Date(hoy);
        mesAtras.setMonth(mesAtras.getMonth() - 1);
        inicio = mesAtras.toISOString().split("T")[0];
        break;
    }

    onFiltrosChange({
      ...filtros,
      fechaInicio: inicio,
      fechaFin: fin,
    });
  };

  const hayFiltrosActivos =
    filtros.busqueda ||
    filtros.fechaInicio ||
    filtros.fechaFin ||
    filtros.cajero !== "todos" ||
    filtros.estado !== "todos";

  return (
    <Card>
      <CardContent className="p-3 sm:p-4 space-y-3 sm:space-y-4">
        <div className="flex flex-col sm:flex-row gap-2">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
            <Input
              placeholder="Buscar por folio..."
              value={filtros.busqueda}
              onChange={(e) => handleChange("busqueda", e.target.value)}
              onKeyDown={handleKeyDown}
              className="pl-9"
            />
          </div>
          <div className="flex gap-2">
            <Button
              variant="outline"
              onClick={() => setMostrarFiltros(!mostrarFiltros)}
              className="gap-2 flex-1 sm:flex-initial"
            >
              <Filter className="h-4 w-4" />
              <span className="hidden sm:inline">Filtros</span>
            </Button>
            <Button
              onClick={onAplicarFiltros}
              disabled={loading}
              className="gap-2 flex-1 sm:flex-initial sm:min-w-25"
            >
              {loading ? "Buscando..." : "Buscar"}
            </Button>
            {hayFiltrosActivos && (
              <Button
                variant="ghost"
                onClick={limpiarFiltros}
                className="gap-2 hidden sm:flex"
              >
                <X className="h-4 w-4" />
                Limpiar
              </Button>
            )}
          </div>
        </div>

        <div className="flex flex-wrap gap-2">
          <Button
            variant="outline"
            size="sm"
            onClick={() => establecerRangoFecha("hoy")}
            className="flex-1 sm:flex-initial"
          >
            <Calendar className="h-3 w-3 sm:mr-1" />
            <span className="text-xs sm:text-sm">Hoy</span>
          </Button>
          <Button
            variant="outline"
            size="sm"
            onClick={() => establecerRangoFecha("semana")}
            className="flex-1 sm:flex-initial"
          >
            <span className="text-xs sm:text-sm">7 días</span>
          </Button>
          <Button
            variant="outline"
            size="sm"
            onClick={() => establecerRangoFecha("mes")}
            className="flex-1 sm:flex-initial"
          >
            <span className="text-xs sm:text-sm">30 días</span>
          </Button>
          {hayFiltrosActivos && (
            <Button
              variant="ghost"
              size="sm"
              onClick={limpiarFiltros}
              className="flex sm:hidden gap-1"
            >
              <X className="h-3 w-3" />
              <span className="text-xs">Limpiar</span>
            </Button>
          )}
        </div>

        {mostrarFiltros && (
          <div className="grid gap-3 sm:gap-4 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 pt-3 sm:pt-4 border-t">
            <div className="space-y-2">
              <Label className="text-sm">Fecha Inicio</Label>
              <Input
                type="date"
                value={filtros.fechaInicio}
                onChange={(e) => handleChange("fechaInicio", e.target.value)}
              />
            </div>

            <div className="space-y-2">
              <Label className="text-sm">Fecha Fin</Label>
              <Input
                type="date"
                value={filtros.fechaFin}
                onChange={(e) => handleChange("fechaFin", e.target.value)}
              />
            </div>

            <div className="space-y-2">
              <Label className="text-sm">Cajero</Label>
              <Select
                value={filtros.cajero}
                onValueChange={(value) => handleChange("cajero", value)}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="todos">Todos</SelectItem>
                  {cajeros.map((cajero) => (
                    <SelectItem key={cajero.id} value={cajero.id}>
                      {cajero.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <Label className="text-sm">Estado</Label>
              <Select
                value={filtros.estado}
                onValueChange={(value: "todos" | "abiertos" | "cerrados") =>
                  handleChange("estado", value)
                }
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="todos">Todos</SelectItem>
                  <SelectItem value="abiertos">Abiertos</SelectItem>
                  <SelectItem value="cerrados">Cerrados</SelectItem>
                </SelectContent>
              </Select>
            </div>

            <div className="space-y-2">
              <Label className="text-sm">Ordenar Por</Label>
              <Select
                value={filtros.ordenarPor}
                onValueChange={(
                  value:
                    | "fecha_desc"
                    | "fecha_asc"
                    | "folio_desc"
                    | "folio_asc",
                ) => handleChange("ordenarPor", value)}
              >
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="fecha_desc">
                    Fecha (más reciente)
                  </SelectItem>
                  <SelectItem value="fecha_asc">Fecha (más antiguo)</SelectItem>
                  <SelectItem value="folio_desc">Folio (Z-A)</SelectItem>
                  <SelectItem value="folio_asc">Folio (A-Z)</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  );
}


### FILE: app/(dashboard)/cortes/_components/cortes-lista.tsx ###

"use client";

import { Badge } from "@/components/ui/badge";
import { Button } from "@/components/ui/button";
import { Eye, Calendar, ChevronLeft, ChevronRight, User } from "lucide-react";
import type { CorteResponse } from "@/types/api/shifts";
import { formatearFechaCorte } from "@/lib/domain/shifts";
import { tieneDiferenciaSignificativa } from "@/lib/domain/shifts";

interface CortesListaProps {
  cortes: CorteResponse[];
  loading: boolean;
  currentPage: number;
  totalPages: number;
  onPageChange: (page: number) => void;
  onVerDetalle: (corteId: number) => void;
}

export default function CortesLista({
  cortes,
  loading,
  currentPage,
  totalPages,
  onPageChange,
  onVerDetalle,
}: CortesListaProps) {
  if (loading) {
    return (
      <p className="text-center text-muted-foreground py-8">Cargando...</p>
    );
  }

  if (!cortes || cortes.length === 0) {
    return (
      <p className="text-center text-muted-foreground py-8">Sin resultados</p>
    );
  }

  return (
    <>
      <div className="space-y-3 sm:space-y-4">
        {cortes.map((corte) => {
          const estaCerrado = corte.status === "CLOSED";
          const diferencia = estaCerrado ? Number(corte.difference) : 0;
          const tieneDiferencia =
            estaCerrado && tieneDiferenciaSignificativa(diferencia);

          return (
            <div
              key={corte.id}
              className={`border rounded-lg p-3 sm:p-4 ${
                !estaCerrado
                  ? "bg-blue-50 dark:bg-blue-950/20 border-blue-200 dark:border-blue-900"
                  : ""
              } ${tieneDiferencia ? "bg-yellow-50 dark:bg-yellow-950/20 border-yellow-200 dark:border-yellow-900" : ""}`}
            >
              <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3 mb-3">
                <div className="flex-1 min-w-0">
                  <div className="flex flex-wrap items-center gap-2 mb-2">
                    <strong className="text-sm sm:text-base truncate">
                      {corte.folio}
                    </strong>
                    {estaCerrado ? (
                      <Badge variant="secondary" className="shrink-0">
                        Cerrado
                      </Badge>
                    ) : (
                      <Badge className="bg-blue-600 dark:bg-blue-700 text-white shrink-0">
                        Abierto
                      </Badge>
                    )}
                    {tieneDiferencia && (
                      <Badge
                        variant="outline"
                        className="bg-yellow-50 dark:bg-yellow-950/30 text-yellow-700 dark:text-yellow-500 border-yellow-200 dark:border-yellow-800 shrink-0"
                      >
                        Con diferencia
                      </Badge>
                    )}
                  </div>

                  <div className="space-y-1 text-xs sm:text-sm text-muted-foreground">
                    <div className="flex items-center gap-2">
                      <User className="h-3 w-3 shrink-0" />
                      <span className="truncate">
                        {corte.cashier?.name || "Sin cajero"}
                      </span>
                    </div>

                    <div className="flex items-center gap-2">
                      <Calendar className="h-3 w-3 shrink-0" />
                      <span className="truncate">
                        Apertura: {formatearFechaCorte(corte.openingDate)}
                      </span>
                    </div>

                    {estaCerrado && corte.closingDate && (
                      <div className="flex items-center gap-2">
                        <Calendar className="h-3 w-3 shrink-0" />
                        <span className="truncate">
                          Cierre: {formatearFechaCorte(corte.closingDate)}
                        </span>
                      </div>
                    )}
                  </div>
                </div>

                <div className="text-left sm:text-right shrink-0">
                  <p className="text-xl sm:text-2xl font-bold">
                    $
                    {estaCerrado ? Number(corte.totalSales).toFixed(2) : "0.00"}
                  </p>
                  <p className="text-xs sm:text-sm text-muted-foreground">
                    Fondo: ${Number(corte.initialCash).toFixed(2)}
                  </p>
                  {tieneDiferencia && (
                    <p
                      className={`text-xs sm:text-sm font-medium ${
                        diferencia > 0
                          ? "text-green-600 dark:text-green-500"
                          : "text-red-600 dark:text-red-500"
                      }`}
                    >
                      Dif: ${Math.abs(diferencia).toFixed(2)}{" "}
                      {diferencia > 0 ? "↑" : "↓"}
                    </p>
                  )}
                </div>
              </div>

              {estaCerrado && (
                <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 bg-muted/50 rounded p-2 sm:p-3 border-t text-xs sm:text-sm">
                  <div>
                    <p className="text-muted-foreground">Tickets</p>
                    <p className="font-medium">{corte.ticketCount}</p>
                  </div>
                  <div>
                    <p className="text-muted-foreground">Efectivo</p>
                    <p className="font-medium">
                      ${Number(corte.cashAmount).toFixed(2)}
                    </p>
                  </div>
                  <div>
                    <p className="text-muted-foreground">Tarjetas</p>
                    <p className="font-medium">
                      $
                      {(
                        Number(corte.debitCardAmount) +
                        Number(corte.creditCardAmount)
                      ).toFixed(2)}
                    </p>
                  </div>
                  <div>
                    <p className="text-muted-foreground">Retiros</p>
                    <p className="font-medium text-red-600 dark:text-red-500">
                      ${Number(corte.totalWithdrawals).toFixed(2)}
                    </p>
                  </div>
                </div>
              )}

              <div className="flex gap-2 mt-3 pt-3 border-t">
                <Button
                  size="sm"
                  variant="outline"
                  onClick={() => onVerDetalle(corte.id)}
                  className="gap-2 flex-1 sm:flex-initial"
                >
                  <Eye className="h-4 w-4" />
                  Ver Detalle
                </Button>
              </div>
            </div>
          );
        })}
      </div>

      {totalPages > 1 && (
        <div className="flex flex-col sm:flex-row items-center justify-between gap-3 mt-6 pt-4 border-t">
          <p className="text-xs sm:text-sm text-muted-foreground order-2 sm:order-1">
            Página {currentPage} de {totalPages}
          </p>
          <div className="flex gap-2 order-1 sm:order-2 w-full sm:w-auto">
            <Button
              size="sm"
              variant="outline"
              disabled={currentPage === 1 || loading}
              onClick={() => onPageChange(currentPage - 1)}
              className="flex-1 sm:flex-initial"
            >
              <ChevronLeft className="h-4 w-4 sm:mr-1" />
              <span className="hidden sm:inline">Anterior</span>
            </Button>

            <Button
              size="sm"
              variant="outline"
              disabled={currentPage === totalPages || loading}
              onClick={() => onPageChange(currentPage + 1)}
              className="flex-1 sm:flex-initial"
            >
              <span className="hidden sm:inline">Siguiente</span>
              <ChevronRight className="h-4 w-4 sm:ml-1" />
            </Button>
          </div>
        </div>
      )}
    </>
  );
}


### FILE: app/(dashboard)/cortes/_components/cortes-manager.tsx ###

"use client";

import { useState, useEffect, useCallback } from "react";
import { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { X, Plus, DollarSign, Clock, CheckCircle } from "lucide-react";
import CortesFiltros, { type FiltrosCorte } from "./cortes-filtros";
import CortesLista from "./cortes-lista";
import AbrirCorteModal from "./abrir-corte-modal";
import CerrarCorteModal from "./cerrar-corte-modal";
import DetalleCorteModal from "./detalle-corte-modal";
import type {
  CorteResponse,
  CorteActivoConVentasResponse,
  OpenShiftInput,
  CloseShiftInput,
  BuscarCortesQuery,
  ResumenCorteResponse,
  CorteConVentasResponse,
} from "@/types/api/shifts";
import {
  abrirCorte,
  cerrarCorte,
  cargarCortes,
  verificarCorteActivo,
  cargarResumenCorte,
  cargarDetalleCorte,
} from "@/lib/domain/shifts";

interface Cajero {
  id: string;
  name: string;
}

interface CortesManagerProps {
  cajeros: Cajero[];
  currentUserId: string;
}

const ITEMS_POR_PAGINA = 10;

const filtrosIniciales: FiltrosCorte = {
  busqueda: "",
  fechaInicio: "",
  fechaFin: "",
  cajero: "todos",
  estado: "todos",
  ordenarPor: "fecha_desc",
};

export default function CortesManager({ cajeros }: CortesManagerProps) {
  // Estados de datos
  const [cortes, setCortes] = useState<CorteResponse[]>([]);
  const [corteActivo, setCorteActivo] =
    useState<CorteActivoConVentasResponse | null>(null);
  const [totalCortes, setTotalCortes] = useState(0);

  // Estados de UI
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState("");
  const [paginaActual, setPaginaActual] = useState(1);
  const [filtros, setFiltros] = useState<FiltrosCorte>(filtrosIniciales);

  // Estados de modales
  const [mostrarAbrirModal, setMostrarAbrirModal] = useState(false);
  const [mostrarCerrarModal, setMostrarCerrarModal] = useState(false);
  const [corteDetalle, setCorteDetalle] = useState<number | null>(null);
  const [errorModal, setErrorModal] = useState("");

  /**
   * Verifica si existe un corte activo
   */
  const verificarActivo = useCallback(async () => {
    const resultado = await verificarCorteActivo();
    if (resultado.success) {
      setCorteActivo(resultado.corte ?? null);
    }
  }, []);

  /**
   * Carga la lista de cortes con filtros
   */
  const cargarDatos = useCallback(
    async (nuevosFiltros?: FiltrosCorte, pagina: number = 1) => {
      setLoading(true);
      setError("");

      try {
        const filtrosActuales = nuevosFiltros || filtros;
        const params: BuscarCortesQuery = {};

        if (filtrosActuales.busqueda) params.search = filtrosActuales.busqueda;
        if (filtrosActuales.fechaInicio)
          params.startDate = filtrosActuales.fechaInicio;
        if (filtrosActuales.fechaFin) params.endDate = filtrosActuales.fechaFin;
        if (filtrosActuales.cajero !== "todos")
          params.cashier = filtrosActuales.cajero;
        if (filtrosActuales.estado !== "todos")
          params.status = filtrosActuales.estado;

        const [campo, orden] = filtrosActuales.ordenarPor.split("_");
        params.orderBy = campo;
        params.order = orden;
        params.page = pagina.toString();
        params.perPage = ITEMS_POR_PAGINA.toString();

        const resultado = await cargarCortes(params);

        if (resultado.success && resultado.data) {
          setCortes(resultado.data.shifts);
          setTotalCortes(resultado.data.total);
          setPaginaActual(pagina);
        } else {
          setError(resultado.error || "Error al cargar cortes");
        }
      } catch (err) {
        setError(err instanceof Error ? err.message : "Error desconocido");
      } finally {
        setLoading(false);
      }
    },
    [filtros],
  );

  /**
   * Carga inicial de datos
   */
  useEffect(() => {
    cargarDatos();
    verificarActivo();
  }, [cargarDatos, verificarActivo]);

  /**
   * Handlers de filtros
   */
  const handleFiltrosChange = (nuevosFiltros: FiltrosCorte) => {
    setFiltros(nuevosFiltros);
  };

  const handleAplicarFiltros = () => {
    cargarDatos(filtros, 1);
  };

  const handleCambiarPagina = (pagina: number) => {
    cargarDatos(filtros, pagina);
  };

  /**
   * Handlers de modales
   */
  const handleAbrirModal = () => {
    setMostrarAbrirModal(true);
    setErrorModal("");
  };

  const handleCerrarModal = () => {
    if (!corteActivo) return;
    setMostrarCerrarModal(true);
    setErrorModal("");
  };

  /**
   * Handler de abrir corte
   */
  const handleAbrirCorte = async (data: OpenShiftInput) => {
    const resultado = await abrirCorte(data);

    if (resultado.success) {
      setMostrarAbrirModal(false);
      await verificarActivo();
      await cargarDatos(filtros, 1);
    } else {
      setErrorModal(resultado.error || "Error al abrir corte");
      throw new Error(resultado.error);
    }
  };

  /**
   * Handler de cerrar corte
   */
  const handleCerrarCorte = async (data: CloseShiftInput) => {
    const resultado = await cerrarCorte(data);

    if (resultado.success) {
      setMostrarCerrarModal(false);
      setCorteActivo(null);
      await cargarDatos(filtros, 1);
    } else {
      setErrorModal(resultado.error || "Error al cerrar corte");
      throw new Error(resultado.error);
    }
  };

  /**
   * Handler de ver detalle
   */
  const handleVerDetalle = (corteId: number) => {
    setCorteDetalle(corteId);
  };

  /**
   * Handler de cargar resumen para modal de cierre
   */
  const handleCargarResumen = async (
    corteId: number,
  ): Promise<ResumenCorteResponse> => {
    const resultado = await cargarResumenCorte(corteId);

    if (resultado.success && resultado.resumen) {
      return resultado.resumen;
    }

    throw new Error(resultado.error || "Error al cargar resumen");
  };

  /**
   * Handler de cargar detalle para modal de detalle
   */
  const handleCargarDetalleCorte = async (
    corteId: number,
  ): Promise<CorteConVentasResponse> => {
    const resultado = await cargarDetalleCorte(corteId);

    if (resultado.success && resultado.corte) {
      return resultado.corte;
    }

    throw new Error(resultado.error || "Error al cargar detalle");
  };

  const totalPaginas = Math.ceil(totalCortes / ITEMS_POR_PAGINA);
  const cortesCerrados = cortes.filter((c) => c.status === "CLOSED").length;
  const cortesAbiertos = cortes.filter((c) => c.status === "OPEN").length;

  return (
    <div className="space-y-4 sm:space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <h1 className="text-2xl sm:text-3xl font-bold">Cortes de Caja</h1>
          <p className="text-sm sm:text-base text-muted-foreground">
            Gestión de turnos y arqueos
          </p>
        </div>
        <div className="flex gap-2">
          {corteActivo ? (
            <Button
              onClick={handleCerrarModal}
              variant="destructive"
              className="gap-2 flex-1 sm:flex-initial"
            >
              <CheckCircle className="h-4 w-4" />
              Cerrar Corte
            </Button>
          ) : (
            <Button
              onClick={handleAbrirModal}
              className="gap-2 flex-1 sm:flex-initial"
            >
              <Plus className="h-4 w-4" />
              Abrir Corte
            </Button>
          )}
        </div>
      </div>

      {/* Error global */}
      {error && (
        <div className="rounded-lg bg-destructive/10 p-3 text-sm text-destructive flex justify-between items-start gap-2">
          <span className="flex-1">{error}</span>
          <Button variant="ghost" size="sm" onClick={() => setError("")}>
            <X className="h-4 w-4" />
          </Button>
        </div>
      )}

      {/* Corte activo */}
      {corteActivo && (
        <Card className="border-blue-200 dark:border-blue-900 bg-blue-50 dark:bg-blue-950/20">
          <CardContent className="p-4">
            <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
              <div className="flex items-center gap-3">
                <Clock className="h-5 w-5 text-blue-600 dark:text-blue-400 shrink-0" />
                <div>
                  <p className="font-medium text-blue-900 dark:text-blue-100">
                    Corte Activo: {corteActivo.folio}
                  </p>
                  <p className="text-sm text-blue-700 dark:text-blue-300">
                    Fondo inicial: ${Number(corteActivo.initialCash).toFixed(2)}
                  </p>
                </div>
              </div>
              <span className="bg-blue-600 dark:bg-blue-700 text-white px-3 py-1 rounded-md text-sm w-fit">
                En curso
              </span>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Estadísticas */}
      <div className="grid gap-3 sm:gap-4 grid-cols-2 lg:grid-cols-4">
        <Card>
          <CardContent className="pt-4 sm:pt-6">
            <div className="flex items-center gap-3">
              <DollarSign className="h-6 w-6 sm:h-8 sm:w-8 text-green-600 dark:text-green-500 shrink-0" />
              <div className="min-w-0">
                <p className="text-xs sm:text-sm text-muted-foreground">
                  Total Cortes
                </p>
                <p className="text-lg sm:text-2xl font-bold truncate">
                  {totalCortes}
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="pt-4 sm:pt-6">
            <div className="flex items-center gap-3">
              <CheckCircle className="h-6 w-6 sm:h-8 sm:w-8 text-blue-600 dark:text-blue-500 shrink-0" />
              <div className="min-w-0">
                <p className="text-xs sm:text-sm text-muted-foreground">
                  Cerrados
                </p>
                <p className="text-lg sm:text-2xl font-bold truncate">
                  {cortesCerrados}
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="pt-4 sm:pt-6">
            <div className="flex items-center gap-3">
              <Clock className="h-6 w-6 sm:h-8 sm:w-8 text-orange-600 dark:text-orange-500 shrink-0" />
              <div className="min-w-0">
                <p className="text-xs sm:text-sm text-muted-foreground">
                  Abiertos
                </p>
                <p className="text-lg sm:text-2xl font-bold truncate">
                  {cortesAbiertos}
                </p>
              </div>
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="pt-4 sm:pt-6">
            <div className="min-w-0">
              <p className="text-xs sm:text-sm text-muted-foreground">
                Cajeros Activos
              </p>
              <p className="text-lg sm:text-2xl font-bold truncate">
                {cajeros.length}
              </p>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Filtros */}
      <CortesFiltros
        filtros={filtros}
        onFiltrosChange={handleFiltrosChange}
        onAplicarFiltros={handleAplicarFiltros}
        cajeros={cajeros}
        loading={loading}
      />

      {/* Lista de cortes */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center justify-between text-base sm:text-lg">
            <span>Historial de Cortes</span>
            <span className="text-xs sm:text-sm font-normal text-muted-foreground">
              {totalCortes} registros
            </span>
          </CardTitle>
        </CardHeader>
        <CardContent>
          <CortesLista
            cortes={cortes}
            loading={loading}
            currentPage={paginaActual}
            totalPages={totalPaginas}
            onPageChange={handleCambiarPagina}
            onVerDetalle={handleVerDetalle}
          />
        </CardContent>
      </Card>

      {/* Modales */}
      <AbrirCorteModal
        open={mostrarAbrirModal}
        onClose={() => setMostrarAbrirModal(false)}
        onSubmit={handleAbrirCorte}
        error={errorModal}
      />

      {corteActivo && (
        <CerrarCorteModal
          open={mostrarCerrarModal}
          corte={corteActivo}
          onClose={() => setMostrarCerrarModal(false)}
          onLoadResumen={handleCargarResumen}
          onSubmit={handleCerrarCorte}
          error={errorModal}
        />
      )}

      {corteDetalle !== null && (
        <DetalleCorteModal
          open={true}
          corteId={corteDetalle}
          onClose={() => setCorteDetalle(null)}
          onLoadDetalle={handleCargarDetalleCorte}
        />
      )}
    </div>
  );
}


### FILE: app/(dashboard)/cortes/_components/cortes-skeleton.tsx ###

"use client";

import { Card, CardContent, CardHeader } from "@/components/ui/card";
import { Skeleton } from "@/components/ui/skeleton";

export default function CortesSkeleton() {
  return (
    <div className="space-y-4 sm:space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
          <Skeleton className="h-8 w-48 mb-2" />
          <Skeleton className="h-4 w-64" />
        </div>
        <Skeleton className="h-10 w-32" />
      </div>

      {/* Estadísticas */}
      <div className="grid gap-3 sm:gap-4 grid-cols-2 lg:grid-cols-4">
        {[1, 2, 3, 4].map((i) => (
          <Card key={i}>
            <CardContent className="pt-4 sm:pt-6">
              <div className="flex items-center gap-3">
                <Skeleton className="h-8 w-8 rounded-full" />
                <div className="flex-1">
                  <Skeleton className="h-4 w-20 mb-2" />
                  <Skeleton className="h-6 w-16" />
                </div>
              </div>
            </CardContent>
          </Card>
        ))}
      </div>

      {/* Filtros */}
      <Card>
        <CardContent className="p-3 sm:p-4 space-y-3">
          <div className="flex gap-2">
            <Skeleton className="h-10 flex-1" />
            <Skeleton className="h-10 w-24" />
            <Skeleton className="h-10 w-24" />
          </div>
          <div className="flex gap-2">
            {[1, 2, 3].map((i) => (
              <Skeleton key={i} className="h-8 flex-1" />
            ))}
          </div>
        </CardContent>
      </Card>

      {/* Lista */}
      <Card>
        <CardHeader>
          <Skeleton className="h-6 w-48" />
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            {[1, 2, 3].map((i) => (
              <div key={i} className="border rounded-lg p-4">
                <div className="flex justify-between mb-3">
                  <div>
                    <Skeleton className="h-5 w-32 mb-2" />
                    <Skeleton className="h-4 w-48" />
                  </div>
                  <Skeleton className="h-6 w-24" />
                </div>
                <div className="grid grid-cols-4 gap-2">
                  {[1, 2, 3, 4].map((j) => (
                    <div key={j}>
                      <Skeleton className="h-4 w-full mb-1" />
                      <Skeleton className="h-5 w-16" />
                    </div>
                  ))}
                </div>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    </div>
  );
}


### FILE: app/(dashboard)/cortes/_components/detalle-corte-modal.tsx ###

"use client";

import { useState, useEffect, useCallback } from "react";
import { Button } from "@/components/ui/button";
import { Badge } from "@/components/ui/badge";
import { Dialog, DialogContent, DialogTitle } from "@/components/ui/dialog";
import { Loader2, DollarSign, Receipt, AlertCircle } from "lucide-react";
import type { CorteConVentasResponse } from "@/types/api/shifts";
import { formatearFechaLarga } from "@/lib/domain/shifts";
import {
  tieneDiferenciaSignificativa,
  tipoDiferencia,
} from "@/lib/domain/shifts";

interface DetalleCorteModalProps {
  open: boolean;
  corteId: number;
  onClose: () => void;
  onLoadDetalle: (corteId: number) => Promise<CorteConVentasResponse>;
}

export default function DetalleCorteModal({
  open,
  corteId,
  onClose,
  onLoadDetalle,
}: DetalleCorteModalProps) {
  const [corte, setCorte] = useState<CorteConVentasResponse | null>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState("");

  const cargarDetalle = useCallback(async () => {
    try {
      setLoading(true);
      const data = await onLoadDetalle(corteId);
      setCorte(data);
    } catch (err) {
      setError(err instanceof Error ? err.message : "Error desconocido");
    } finally {
      setLoading(false);
    }
  }, [corteId, onLoadDetalle]);

  useEffect(() => {
    if (open) {
      cargarDetalle();
    }
  }, [open, cargarDetalle]);

  const handleClose = () => {
    setCorte(null);
    setError("");
    onClose();
  };

  if (loading) {
    return (
      <Dialog open={open} onOpenChange={handleClose}>
        <DialogContent className="sm:max-w-3xl">
          <DialogTitle className="sr-only">Detalle del Corte</DialogTitle>
          <div className="flex items-center justify-center py-8">
            <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
          </div>
        </DialogContent>
      </Dialog>
    );
  }

  if (error || !corte) {
    return (
      <Dialog open={open} onOpenChange={handleClose}>
        <DialogContent className="sm:max-w-md">
          <DialogTitle className="sr-only">Detalle del Corte</DialogTitle>
          <div className="text-center py-8">
            <p className="text-destructive">{error || "Corte no encontrado"}</p>
            <Button onClick={handleClose} className="mt-4">
              Cerrar
            </Button>
          </div>
        </DialogContent>
      </Dialog>
    );
  }

  const estaCerrado = corte.status === "CLOSED";
  const diferencia = estaCerrado ? Number(corte.difference) : 0;
  const tieneDiferencia =
    estaCerrado && tieneDiferenciaSignificativa(diferencia);
  const tipo = tipoDiferencia(diferencia);

  return (
    <Dialog open={open} onOpenChange={handleClose}>
      <DialogContent
        className="sm:max-w-3xl max-h-[90vh] overflow-y-auto"
        showCloseButton={true}
      >
        <DialogTitle>Detalle del Corte</DialogTitle>

        <div className="space-y-4 sm:space-y-6">
          <div className="bg-muted/50 rounded-lg p-4 border">
            <div className="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
              <div>
                <h2 className="text-xl font-bold">{corte.folio}</h2>
                <p className="text-sm text-muted-foreground">
                  Cajero: {corte.cashier?.name || "Sin cajero"}
                </p>
              </div>
              <div className="flex gap-2">
                {estaCerrado ? (
                  <Badge variant="secondary">Cerrado</Badge>
                ) : (
                  <Badge className="bg-blue-600 dark:bg-blue-700 text-white">
                    Abierto
                  </Badge>
                )}
                {tieneDiferencia && estaCerrado && (
                  <Badge
                    variant="outline"
                    className="bg-yellow-50 dark:bg-yellow-950/30 text-yellow-700 dark:text-yellow-500 border-yellow-200 dark:border-yellow-800"
                  >
                    Con diferencia
                  </Badge>
                )}
              </div>
            </div>
          </div>

          <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div className="bg-blue-50 dark:bg-blue-950/20 rounded-lg p-4 border border-blue-200 dark:border-blue-900">
              <p className="text-sm text-blue-700 dark:text-blue-400 font-medium mb-1">
                Apertura
              </p>
              <p className="text-sm">
                {formatearFechaLarga(corte.openingDate)}
              </p>
            </div>
            {estaCerrado && corte.closingDate && (
              <div className="bg-green-50 dark:bg-green-950/20 rounded-lg p-4 border border-green-200 dark:border-green-900">
                <p className="text-sm text-green-700 dark:text-green-400 font-medium mb-1">
                  Cierre
                </p>
                <p className="text-sm">
                  {formatearFechaLarga(corte.closingDate)}
                </p>
              </div>
            )}
          </div>

          <div>
            <h3 className="font-semibold mb-3 flex items-center gap-2">
              <Receipt className="h-4 w-4" />
              Resumen de Ventas
            </h3>
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
              <div className="bg-muted/50 rounded-lg p-3 border">
                <p className="text-xs text-muted-foreground mb-1">Tickets</p>
                <p className="text-lg font-bold">
                  {estaCerrado ? corte.ticketCount : 0}
                </p>
              </div>
              <div className="bg-muted/50 rounded-lg p-3 border">
                <p className="text-xs text-muted-foreground mb-1">Membresías</p>
                <p className="text-lg font-bold">
                  ${Number(estaCerrado ? corte.membershipSales : 0).toFixed(2)}
                </p>
              </div>
              <div className="bg-muted/50 rounded-lg p-3 border">
                <p className="text-xs text-muted-foreground mb-1">Productos</p>
                <p className="text-lg font-bold">
                  $
                  {(estaCerrado
                    ? Number(corte.productSales0Tax) +
                      Number(corte.productSales16Tax)
                    : 0
                  ).toFixed(2)}
                </p>
              </div>
              <div className="bg-muted/50 rounded-lg p-3 border">
                <p className="text-xs text-muted-foreground mb-1">IVA</p>
                <p className="text-lg font-bold">
                  ${(estaCerrado ? Number(corte.tax) : 0).toFixed(2)}
                </p>
              </div>
            </div>
          </div>

          <div>
            <h3 className="font-semibold mb-3 flex items-center gap-2">
              <DollarSign className="h-4 w-4" />
              Formas de Pago
            </h3>
            <div className="grid grid-cols-2 sm:grid-cols-4 gap-3 sm:gap-4">
              <div className="bg-green-50 dark:bg-green-950/20 rounded-lg p-3 border border-green-200 dark:border-green-900">
                <p className="text-xs text-green-700 dark:text-green-400 mb-1">
                  Efectivo
                </p>
                <p className="text-lg font-bold">
                  ${(estaCerrado ? Number(corte.cashAmount) : 0).toFixed(2)}
                </p>
              </div>
              <div className="bg-blue-50 dark:bg-blue-950/20 rounded-lg p-3 border border-blue-200 dark:border-blue-900">
                <p className="text-xs text-blue-700 dark:text-blue-400 mb-1">
                  T. Débito
                </p>
                <p className="text-lg font-bold">
                  $
                  {(estaCerrado ? Number(corte.debitCardAmount) : 0).toFixed(2)}
                </p>
              </div>
              <div className="bg-purple-50 dark:bg-purple-950/20 rounded-lg p-3 border border-purple-200 dark:border-purple-900">
                <p className="text-xs text-purple-700 dark:text-purple-400 mb-1">
                  T. Crédito
                </p>
                <p className="text-lg font-bold">
                  $
                  {(estaCerrado ? Number(corte.creditCardAmount) : 0).toFixed(
                    2,
                  )}
                </p>
              </div>
              <div className="bg-orange-50 dark:bg-orange-950/20 rounded-lg p-3 border border-orange-200 dark:border-orange-900">
                <p className="text-xs text-orange-700 dark:text-orange-400 mb-1">
                  Vouchers
                </p>
                <p className="text-lg font-bold">
                  ${(estaCerrado ? Number(corte.totalVoucher) : 0).toFixed(2)}
                </p>
              </div>
            </div>
          </div>

          {estaCerrado && (
            <div className="bg-muted/50 rounded-lg p-4 border">
              <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                <div>
                  <p className="text-sm text-muted-foreground mb-1">
                    Fondo Inicial
                  </p>
                  <p className="text-xl font-bold">
                    ${Number(corte.initialCash).toFixed(2)}
                  </p>
                </div>
                <div>
                  <p className="text-sm text-muted-foreground mb-1">
                    Total Ventas
                  </p>
                  <p className="text-xl font-bold">
                    ${Number(corte.totalSales).toFixed(2)}
                  </p>
                </div>
                <div>
                  <p className="text-sm text-muted-foreground mb-1">
                    Total en Caja
                  </p>
                  <p className="text-xl font-bold">
                    ${Number(corte.totalCash).toFixed(2)}
                  </p>
                </div>
              </div>
            </div>
          )}

          {estaCerrado &&
            (Number(corte.totalWithdrawals) > 0 ||
              Number(corte.cancelledSales) > 0) && (
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                {Number(corte.totalWithdrawals) > 0 && (
                  <div className="bg-red-50 dark:bg-red-950/20 rounded-lg p-4 border border-red-200 dark:border-red-900">
                    <p className="text-sm text-red-700 dark:text-red-400 font-medium mb-2">
                      Retiros
                    </p>
                    <p className="text-2xl font-bold text-red-600 dark:text-red-500">
                      ${Number(corte.totalWithdrawals).toFixed(2)}
                    </p>
                    {corte.withdrawalsConcept && (
                      <p className="text-xs text-muted-foreground mt-2">
                        {corte.withdrawalsConcept}
                      </p>
                    )}
                  </div>
                )}
                {Number(corte.cancelledSales) > 0 && (
                  <div className="bg-orange-50 dark:bg-orange-950/20 rounded-lg p-4 border border-orange-200 dark:border-orange-900">
                    <p className="text-sm text-orange-700 dark:text-orange-400 font-medium mb-2">
                      Ventas Canceladas
                    </p>
                    <p className="text-2xl font-bold text-orange-600 dark:text-orange-500">
                      ${Number(corte.cancelledSales).toFixed(2)}
                    </p>
                  </div>
                )}
              </div>
            )}

          {tieneDiferencia && estaCerrado && (
            <div
              className={`rounded-lg p-4 border ${
                tipo === "sobrante"
                  ? "bg-green-50 dark:bg-green-950/20 border-green-200 dark:border-green-900"
                  : "bg-red-50 dark:bg-red-950/20 border-red-200 dark:border-red-900"
              }`}
            >
              <div className="flex items-start gap-3">
                <AlertCircle
                  className={`h-6 w-6 shrink-0 ${
                    tipo === "sobrante"
                      ? "text-green-600 dark:text-green-500"
                      : "text-red-600 dark:text-red-500"
                  }`}
                />
                <div className="flex-1">
                  <p className="font-semibold text-lg">
                    {tipo === "sobrante" ? "Sobrante" : "Faltante"}: $
                    {Math.abs(diferencia).toFixed(2)}
                  </p>
                  <p className="text-sm text-muted-foreground mt-1">
                    {tipo === "sobrante"
                      ? "El arqueo reportó más dinero del esperado"
                      : "El arqueo reportó menos dinero del esperado"}
                  </p>
                </div>
              </div>
            </div>
          )}

          {corte.notes && (
            <div className="bg-muted/50 rounded-lg p-4 border">
              <p className="text-sm font-medium mb-2">Notas</p>
              <p className="text-sm text-muted-foreground whitespace-pre-wrap">
                {corte.notes}
              </p>
            </div>
          )}
        </div>
      </DialogContent>
    </Dialog>
  );
}


### FILE: lib/api/shifts.client.ts ###

// lib/api/shifts.client.ts

import type {
  CorteResponse,
  CorteActivoConVentasResponse,
  CorteConVentasResponse,
  ResumenCorteResponse,
  ListaCortesResponse,
  OpenShiftInput,
  CloseShiftInput,
  BuscarCortesQuery,
} from "@/types/api/shifts";

/**
 * API Client para operaciones de cortes (shifts)
 * Responsabilidad: solo fetch, sin lógica de negocio
 */

export async function fetchAbrirCorte(
  data: OpenShiftInput,
): Promise<CorteResponse> {
  const res = await fetch("/api/shifts", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data),
  });

  if (!res.ok) {
    const error = await res.json();
    throw new Error(error.error || "Error al abrir corte");
  }

  return res.json();
}

export async function fetchCerrarCorte(
  data: CloseShiftInput,
): Promise<CorteResponse> {
  const res = await fetch("/api/shifts/close", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(data),
  });

  if (!res.ok) {
    const error = await res.json();
    throw new Error(error.error || "Error al cerrar corte");
  }

  return res.json();
}

export async function fetchCortes(
  params?: BuscarCortesQuery,
): Promise<ListaCortesResponse> {
  const searchParams = new URLSearchParams();

  if (params?.search) searchParams.append("search", params.search);
  if (params?.startDate) searchParams.append("startDate", params.startDate);
  if (params?.endDate) searchParams.append("endDate", params.endDate);
  if (params?.cashier) searchParams.append("cashier", params.cashier);
  if (params?.status) searchParams.append("status", params.status);
  if (params?.orderBy) searchParams.append("orderBy", params.orderBy);
  if (params?.order) searchParams.append("order", params.order);
  if (params?.page) searchParams.append("page", params.page);
  if (params?.perPage) searchParams.append("perPage", params.perPage);

  const res = await fetch(`/api/shifts?${searchParams}`);

  if (!res.ok) {
    const error = await res.json();
    throw new Error(error.error || "Error al obtener cortes");
  }

  return res.json();
}

export async function fetchCorteActivo(): Promise<CorteActivoConVentasResponse | null> {
  const res = await fetch("/api/shifts/active");

  if (res.status === 404) {
    return null;
  }

  if (!res.ok) {
    const error = await res.json();
    throw new Error(error.error || "Error al obtener corte activo");
  }

  return res.json();
}

export async function fetchCorteById(
  id: number,
): Promise<CorteConVentasResponse> {
  const res = await fetch(`/api/shifts/${id}`);

  if (!res.ok) {
    const error = await res.json();
    throw new Error(error.error || "Error al obtener corte");
  }

  return res.json();
}

export async function fetchResumenCorte(
  id: number,
): Promise<ResumenCorteResponse> {
  const res = await fetch(`/api/shifts/${id}/summary`);

  if (!res.ok) {
    const error = await res.json();
    throw new Error(error.error || "Error al obtener resumen");
  }

  return res.json();
}


### FILE: lib/domain/shifts/index.ts ###

// lib/domain/shifts/index.ts

export * from "./shift-operations";
export * from "./shift-calculations";
export * from "./shift-formatters";


### FILE: lib/domain/shifts/shift-calculations.ts ###

// lib/domain/shifts/shift-calculations.ts

import type { ResumenCorteResponse } from "@/types/api/shifts";

/**
 * Domain Layer - Cálculos de Cortes
 * Responsabilidad: Funciones puras de cálculo
 */

export interface ValoresArqueo {
  cashAmount: number;
  debitCardAmount: number;
  creditCardAmount: number;
  totalWithdrawals: number;
}

/**
 * Calcula la diferencia entre el arqueo real y el esperado
 */
export function calcularDiferencia(
  resumen: ResumenCorteResponse,
  valores: ValoresArqueo,
): number {
  const totalReal =
    valores.cashAmount +
    valores.debitCardAmount +
    valores.creditCardAmount -
    valores.totalWithdrawals;

  const totalEsperado =
    resumen.initialCash + resumen.totalSales - (resumen.totalWithdrawals || 0);

  return Number((totalReal - totalEsperado).toFixed(2));
}

/**
 * Calcula el efectivo esperado en caja
 */
export function calcularEfectivoEsperado(
  resumen: ResumenCorteResponse,
): number {
  return Number(
    (
      resumen.initialCash +
      resumen.cashAmount -
      (resumen.totalWithdrawals || 0)
    ).toFixed(2),
  );
}

/**
 * Verifica si hay una diferencia significativa (> 0.01)
 */
export function tieneDiferenciaSignificativa(diferencia: number): boolean {
  return Math.abs(diferencia) > 0.01;
}

/**
 * Determina el tipo de diferencia
 */
export function tipoDiferencia(
  diferencia: number,
): "sobrante" | "faltante" | "sin_diferencia" {
  if (!tieneDiferenciaSignificativa(diferencia)) {
    return "sin_diferencia";
  }
  return diferencia > 0 ? "sobrante" : "faltante";
}


### FILE: lib/domain/shifts/shift-formatters.ts ###

// lib/domain/shifts/shift-formatters.ts

/**
 * Domain Layer - Formateadores de Cortes
 * Responsabilidad: Formateo de datos para presentación
 */

/**
 * Formatea una fecha a formato local español
 */
export function formatearFechaCorte(fecha: string | Date): string {
  return new Date(fecha).toLocaleString("es-MX", {
    day: "2-digit",
    month: "short",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
}

/**
 * Formatea una fecha a formato largo
 */
export function formatearFechaLarga(fecha: string | Date): string {
  return new Date(fecha).toLocaleString("es-MX", {
    day: "2-digit",
    month: "long",
    year: "numeric",
    hour: "2-digit",
    minute: "2-digit",
  });
}

/**
 * Formatea un monto a moneda local
 */
export function formatearMontoCorte(monto: number): string {
  return `$${monto.toFixed(2)}`;
}


### FILE: lib/domain/shifts/shift-operations.ts ###

// lib/domain/shifts/shift-operations.ts

import {
  fetchAbrirCorte,
  fetchCerrarCorte,
  fetchCortes,
  fetchCorteActivo,
  fetchCorteById,
  fetchResumenCorte,
} from "@/lib/api/shifts.client";
import type {
  CorteResponse,
  CorteActivoConVentasResponse,
  CorteConVentasResponse,
  ResumenCorteResponse,
  ListaCortesResponse,
  OpenShiftInput,
  CloseShiftInput,
  BuscarCortesQuery,
} from "@/types/api/shifts";

/**
 * Domain Layer - Operaciones de Cortes
 * Responsabilidad: Orquestación de flujos de negocio
 */

export interface AbrirCorteResult {
  success: boolean;
  corte?: CorteResponse;
  error?: string;
}

export interface CerrarCorteResult {
  success: boolean;
  corte?: CorteResponse;
  error?: string;
}

export interface CargarCortesResult {
  success: boolean;
  data?: ListaCortesResponse;
  error?: string;
}

export interface VerificarCorteActivoResult {
  success: boolean;
  corte?: CorteActivoConVentasResponse | null;
  error?: string;
}

export interface CargarDetalleCorteResult {
  success: boolean;
  corte?: CorteConVentasResponse;
  error?: string;
}

export interface CargarResumenCorteResult {
  success: boolean;
  resumen?: ResumenCorteResponse;
  error?: string;
}

/**
 * Abre un nuevo corte de caja
 */
export async function abrirCorte(
  data: OpenShiftInput,
): Promise<AbrirCorteResult> {
  try {
    const corte = await fetchAbrirCorte(data);
    return {
      success: true,
      corte,
    };
  } catch (error) {
    return {
      success: false,
      error: error instanceof Error ? error.message : "Error desconocido",
    };
  }
}

/**
 * Cierra el corte de caja actual
 */
export async function cerrarCorte(
  data: CloseShiftInput,
): Promise<CerrarCorteResult> {
  try {
    const corte = await fetchCerrarCorte(data);
    return {
      success: true,
      corte,
    };
  } catch (error) {
    return {
      success: false,
      error: error instanceof Error ? error.message : "Error desconocido",
    };
  }
}

/**
 * Carga la lista de cortes con filtros y paginación
 */
export async function cargarCortes(
  params?: BuscarCortesQuery,
): Promise<CargarCortesResult> {
  try {
    const data = await fetchCortes(params);
    return {
      success: true,
      data,
    };
  } catch (error) {
    return {
      success: false,
      error: error instanceof Error ? error.message : "Error al cargar cortes",
    };
  }
}

/**
 * Verifica si existe un corte activo
 */
export async function verificarCorteActivo(): Promise<VerificarCorteActivoResult> {
  try {
    const corte = await fetchCorteActivo();
    return {
      success: true,
      corte,
    };
  } catch (error) {
    return {
      success: false,
      error:
        error instanceof Error
          ? error.message
          : "Error al verificar corte activo",
    };
  }
}

/**
 * Carga el detalle completo de un corte
 */
export async function cargarDetalleCorte(
  id: number,
): Promise<CargarDetalleCorteResult> {
  try {
    const corte = await fetchCorteById(id);
    return {
      success: true,
      corte,
    };
  } catch (error) {
    return {
      success: false,
      error: error instanceof Error ? error.message : "Error al cargar detalle",
    };
  }
}

/**
 * Carga el resumen de un corte para el arqueo
 */
export async function cargarResumenCorte(
  id: number,
): Promise<CargarResumenCorteResult> {
  try {
    const resumen = await fetchResumenCorte(id);
    return {
      success: true,
      resumen,
    };
  } catch (error) {
    return {
      success: false,
      error: error instanceof Error ? error.message : "Error al cargar resumen",
    };
  }
}


### FILE: types/api/shifts.ts ###

import { z } from "zod";
import type { MetodoPago } from "../models/movimiento-inventario";

// ==================== ZOD SCHEMAS ====================

export const ShiftsQuerySchema = z.object({
  search: z.string().optional(),
  startDate: z.string().optional(),
  endDate: z.string().optional(),
  cashier: z.string().optional(),
  status: z.string().optional(),
  orderBy: z.string().optional(),
  order: z.string().optional(),
  page: z.string().optional(),
  perPage: z.string().optional(),
});

export const OpenShiftSchema = z.object({
  initialCash: z.number().min(0, "El fondo inicial debe ser mayor o igual a 0"),
  notes: z.string().optional(),
});

export const CloseShiftSchema = z.object({
  shiftId: z.number(),
  cashAmount: z.number().min(0).optional(),
  debitCardAmount: z.number().min(0).optional(),
  creditCardAmount: z.number().min(0).optional(),
  totalWithdrawals: z.number().min(0).optional(),
  withdrawalsConcept: z.string().optional(),
  difference: z.number().optional(),
  notes: z.string().optional(),
});

// ==================== INFERRED TYPES ====================

export type ShiftsQueryInput = z.infer<typeof ShiftsQuerySchema>;
export type OpenShiftInput = z.infer<typeof OpenShiftSchema>;
export type CloseShiftInput = z.infer<typeof CloseShiftSchema>;

// ==================== QUERY PARAMS ====================

export interface BuscarCortesQuery {
  search?: string;
  startDate?: string;
  endDate?: string;
  cashier?: string;
  status?: string;
  orderBy?: string;
  order?: string;
  page?: string;
  perPage?: string;
}

// ==================== REQUEST TYPES ====================

export interface AbrirCorteRequest {
  initialCash: number;
  notes?: string;
}

export interface CerrarCorteRequest {
  shiftId: number;
  cashAmount: number;
  debitCardAmount: number;
  creditCardAmount: number;
  totalWithdrawals?: number;
  withdrawalsConcept?: string;
  difference: number;
  notes?: string;
}

// ==================== DISCRIMINATED RESPONSE TYPES ====================

interface BaseCorteResponse {
  id: number;
  folio: string;
  cashierId: string;
  openingDate: Date;
  initialCash: number;
  notes?: string;
  createdAt: Date;
  updatedAt: Date;
  cashier: {
    id: string;
    name: string;
    email: string;
  };
}

export interface CorteActivoResponse extends BaseCorteResponse {
  status: "OPEN";
}

export interface CorteCerradoResponse extends BaseCorteResponse {
  status: "CLOSED";
  closingDate: Date;
  ticketCount: number;
  membershipSales: number;
  productSales0Tax: number;
  productSales16Tax: number;
  subtotal: number;
  tax: number;
  totalSales: number;
  cashAmount: number;
  debitCardAmount: number;
  creditCardAmount: number;
  totalVoucher: number;
  totalWithdrawals: number;
  withdrawalsConcept?: string;
  cancelledSales: number;
  totalCash: number;
  difference: number;
}

export type CorteResponse = CorteActivoResponse | CorteCerradoResponse;

// ==================== EXTENDED RESPONSE TYPES ====================

export interface CorteActivoConVentasResponse extends CorteActivoResponse {
  inventoryMovements: Array<{
    id: number;
    type: string;
    quantity: number;
    ticket?: string;
    total: number;
    paymentMethod?: MetodoPago;
    date: Date;
    product: {
      name: string;
    };
    member?: {
      memberNumber: string;
      name?: string;
    };
  }>;
}

export interface CorteCerradoConVentasResponse extends CorteCerradoResponse {
  inventoryMovements: Array<{
    id: number;
    type: string;
    quantity: number;
    ticket?: string;
    total: number;
    paymentMethod?: MetodoPago;
    date: Date;
    product: {
      name: string;
    };
    member?: {
      memberNumber: string;
      name?: string;
    };
  }>;
}

export type CorteConVentasResponse =
  | CorteActivoConVentasResponse
  | CorteCerradoConVentasResponse;

// ==================== SUMMARY TYPES ====================

export interface ResumenCorteResponse {
  initialCash: number;
  ticketCount: number;
  totalSales: number;
  cashAmount: number;
  debitCardAmount: number;
  creditCardAmount: number;
  totalWithdrawals: number;
}

export interface ListaCortesResponse {
  shifts: CorteResponse[];
  total: number;
  page: number;
  perPage: number;
  totalPages: number;
}

export interface EstadisticasCortesResponse {
  totalShifts: number;
  totalSales: number;
  averageSales: number;
  totalDifferences: number;
}

export interface ResumenVentasPorProducto {
  product: string;
  quantity: number;
  total: number;
}

export interface ResumenPorFormaPago {
  CASH: number;
  DEBIT_CARD: number;
  CREDIT_CARD: number;
  TRANSFER: number;
}
